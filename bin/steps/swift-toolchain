mkdir -p "$CACHE_DIR/$STACK"

case $STACK in
    "heroku-18")
    OS_SHORT=ubuntu1804
    OS_LONG=ubuntu18.04
    ;;

    "heroku-20")
    OS_SHORT=ubuntu2004
    OS_LONG=ubuntu20.04
    ;;

    *)
    echo
    echo " !     The current stack $STACK is not supported."
    echo " !     Please upgrade your stack using the 'heroku stack:set' command or via the dashboard."
    echo
    exit 1

    exit 1
    ;;
esac

if [ -f "$CACHE_DIR/$STACK/swift-$SWIFT_VERSION.installed" ]; then
    puts-step "Swift $SWIFT_VERSION is already installed"
else
    puts-step "Downloading Swift $SWIFT_VERSION"
    SWIFT_PACKAGE=swift-$SWIFT_VERSION-RELEASE-$OS_LONG.tar.gz
    mkdir -p /tmp/swift
    wget -N --show-progress -P "/tmp/swift" https://download.swift.org/swift-$SWIFT_VERSION-release/$OS_SHORT/swift-$SWIFT_VERSION-RELEASE/$SWIFT_PACKAGE

    puts-step "Unpacking Swift toolchain"
    mkdir -p "$CACHE_DIR/$STACK/swift-$SWIFT_VERSION"

    tar -xzf "/tmp/$SWIFT_PACKAGE" --directory "$CACHE_DIR/$STACK/swift-$SWIFT_VERSION" --strip-components=2
    chmod -R o+r "$CACHE_DIR/$STACK/swift-$SWIFT_VERSION/lib/swift"
    rm -rf "/tmp/$SWIFT_PACKAGE"
    touch "$CACHE_DIR/$STACK/swift-$SWIFT_VERSION.installed"
fi

export PATH=$PATH:$CACHE_DIR/$STACK/swift-$SWIFT_VERSION/bin
